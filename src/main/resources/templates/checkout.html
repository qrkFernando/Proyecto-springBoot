<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Finalizar Compra</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-book"></i> Librería Online
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/purchase/history">
                            <i class="fas fa-history me-1"></i>Mis Compras
                        </a>
                    </li>
                </ul>
                
                <!-- Carrito -->
                <a href="/cart" class="btn btn-outline-light position-relative">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                          th:if="${cartItemCount > 0}" th:text="${cartItemCount}">0</span>
                </a>
            </div>
        </div>
    </nav>
    
    <!-- Mensajes de alerta -->
    <div class="container mt-3">
        <div class="alert alert-success alert-dismissible fade show" role="alert" 
             th:if="${successMessage}" th:text="${successMessage}">
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div class="alert alert-danger alert-dismissible fade show" role="alert" 
             th:if="${errorMessage}" th:text="${errorMessage}">
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>

    <main>
        <div class="container mt-4">
            <div class="row">
                <div class="col-md-8">
                    <!-- Formulario de Checkout -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="mb-0">Finalizar Compra</h3>
                        </div>
                        <div class="card-body">
                            <form th:action="@{/purchase/process}" method="post" th:object="${purchase}">
                                <!-- Información del Cliente -->
                                <h5 class="mb-3">Información Personal</h5>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="customerName" class="form-label">Nombre Completo *</label>
                                        <input type="text" class="form-control" id="customerName" 
                                               th:field="*{customerName}" required>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('customerName')}" 
                                             th:errors="*{customerName}"></div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="customerEmail" class="form-label">Email *</label>
                                        <input type="email" class="form-control" id="customerEmail" 
                                               th:field="*{customerEmail}" required>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('customerEmail')}" 
                                             th:errors="*{customerEmail}"></div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="customerPhone" class="form-label">Teléfono *</label>
                                        <input type="tel" class="form-control" id="customerPhone" 
                                               th:field="*{customerPhone}" required>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('customerPhone')}" 
                                             th:errors="*{customerPhone}"></div>
                                    </div>
                                </div>
                                
                                <!-- Dirección de Envío -->
                                <h5 class="mb-3 mt-4">Dirección de Envío</h5>
                                <div class="mb-3">
                                    <label for="shippingAddress" class="form-label">Dirección Completa *</label>
                                    <textarea class="form-control" id="shippingAddress" rows="3" 
                                              th:field="*{shippingAddress}" required 
                                              placeholder="Calle, número, ciudad, código postal"></textarea>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('shippingAddress')}" 
                                         th:errors="*{shippingAddress}"></div>
                                </div>
                                
                                <!-- Método de Pago -->
                                <h5 class="mb-3 mt-4">Método de Pago</h5>
                                <div class="mb-3">
                                    <div th:each="method : ${paymentMethods}" class="form-check">
                                        <input class="form-check-input" type="radio" name="paymentMethod" 
                                               th:value="${method}" th:id="${method}" 
                                               onchange="togglePaymentFields(this.value)" required>
                                        <label class="form-check-label" th:for="${method}" th:text="${method.displayName}">
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Campos de Tarjeta (ocultos por defecto) -->
                                <div id="cardFields" style="display: none;">
                                    <h6 class="mb-3">Información de la Tarjeta</h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="cardHolderName" class="form-label">Nombre del Titular</label>
                                            <input type="text" class="form-control" id="cardHolderName" 
                                                   name="cardHolderName" placeholder="Como aparece en la tarjeta">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="cardNumber" class="form-label">Número de Tarjeta</label>
                                            <input type="text" class="form-control" id="cardNumber" 
                                                   name="cardNumber" placeholder="1234 5678 9012 3456" 
                                                   maxlength="19">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="expiryDate" class="form-label">Fecha de Vencimiento</label>
                                            <input type="text" class="form-control" id="expiryDate" 
                                                   name="expiryDate" placeholder="MM/YY" maxlength="5">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="cvv" class="form-label">CVV</label>
                                            <input type="text" class="form-control" id="cvv" 
                                                   name="cvv" placeholder="123" maxlength="4">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Botones -->
                                <div class="d-flex justify-content-between mt-4">
                                    <a href="/cart" class="btn btn-secondary">Volver al Carrito</a>
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-credit-card me-2"></i>Finalizar Compra
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen del Pedido -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Resumen del Pedido</h5>
                        </div>
                        <div class="card-body">
                            <div th:each="item : ${cartItems}" class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <small th:text="${item.book.title}"></small>
                                    <br>
                                    <small class="text-muted">Cantidad: <span th:text="${item.quantity}"></span></small>
                                </div>
                                <div>
                                    <small th:text="'$' + ${#numbers.formatDecimal(item.subtotal, 1, 2)}"></small>
                                </div>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <strong>Total:</strong>
                                <strong th:text="'$' + ${#numbers.formatDecimal(cartTotal, 1, 2)}" class="text-primary"></strong>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información de Envío -->
                    <div class="card mt-3">
                        <div class="card-body">
                            <h6 class="card-title">Información de Envío</h6>
                            <p class="card-text small">
                                <i class="fas fa-truck text-primary me-2"></i>
                                Envío gratuito en compras superiores a $50<br>
                                <i class="fas fa-clock text-primary me-2"></i>
                                Tiempo estimado: 3-5 días hábiles
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function togglePaymentFields(paymentMethod) {
                const cardFields = document.getElementById('cardFields');
                const cardInputs = cardFields.querySelectorAll('input');
                
                if (paymentMethod === 'CREDIT_CARD' || paymentMethod === 'DEBIT_CARD') {
                    cardFields.style.display = 'block';
                    cardInputs.forEach(input => input.required = true);
                } else {
                    cardFields.style.display = 'none';
                    cardInputs.forEach(input => {
                        input.required = false;
                        input.value = '';
                    });
                }
            }
            
            // Formatear número de tarjeta
            document.getElementById('cardNumber').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                let formattedInputValue = value.match(/.{1,4}/g)?.join(' ') || '';
                e.target.value = formattedInputValue;
            });
            
            // Formatear fecha de vencimiento
            document.getElementById('expiryDate').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });
            
            // Solo números en CVV
            document.getElementById('cvv').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
        </script>
    </main>
    
    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="fas fa-book"></i> Librería Online</h5>
                    <p>Tu librería de confianza con los mejores libros al mejor precio.</p>
                </div>
                <div class="col-md-6">
                    <h6>Contacto</h6>
                    <p>
                        <i class="fas fa-envelope"></i> info@libreria.com<br>
                        <i class="fas fa-phone"></i> +1 234 567 890
                    </p>
                </div>
            </div>
        </div>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>